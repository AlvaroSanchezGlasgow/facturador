<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <title>Crear Nueva Factura</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
</head>
<body>
<div class="container-fluid">
<div layout:fragment="content">
  <h2 class="mb-4">Crear Nueva Factura</h2>

  <form th:action="@{/invoices/new}" th:object="${invoice}" method="post">
    <!-- Campos de la factura -->
    <div class="mb-3">
      <label for="invoiceNumber" class="form-label">Número de Factura:</label>
      <input type="text" id="invoiceNumber" th:field="*{invoiceNumber}" class="form-control" required>
      <div class="text-danger" th:if="${#fields.hasErrors('invoiceNumber')}" th:errors="*{invoiceNumber}"></div>
    </div>

    <div class="mb-3">
      <label for="invoiceDate" class="form-label">Fecha de Factura:</label>
      <input type="date" id="invoiceDate" th:field="*{invoiceDate}" class="form-control" required>
      <div class="text-danger" th:if="${#fields.hasErrors('invoiceDate')}" th:errors="*{invoiceDate}"></div>
    </div>

    <div class="mb-3">
      <label for="dueDate" class="form-label">Fecha de Vencimiento:</label>
      <input type="date" id="dueDate" th:field="*{dueDate}" class="form-control">
      <div class="text-danger" th:if="${#fields.hasErrors('dueDate')}" th:errors="*{dueDate}"></div>
    </div>

    <div class="mb-3">
      <label for="customer" class="form-label">Cliente:</label>
      <select id="customer" th:field="*{customer}" class="form-control" required>
        <option value="">-- Seleccione un Cliente --</option>
        <option th:each="customer : ${customers}" th:value="${customer.id}" th:text="${customer.name}"></option>
      </select>
      <div class="text-danger" th:if="${#fields.hasErrors('customer')}" th:errors="*{customer}"></div>
    </div>

    <!-- Sección para ítems de la factura (esto requerirá JavaScript para añadir/eliminar dinámicamente) -->
    <div id="invoiceItemsContainer">
      <h4>Ítems de la Factura</h4>
      <!-- Los ítems se añadirán aquí dinámicamente -->
    </div>

    <button type="button" class="btn btn-secondary mb-3" onclick="addInvoiceItem()">Añadir Ítem</button>

    <div class="mb-3">
      <label for="notes" class="form-label">Notas:</label>
      <textarea id="notes" th:field="*{notes}" class="form-control"></textarea>
      <div class="text-danger" th:if="${#fields.hasErrors('notes')}" th:errors="*{notes}"></div>
    </div>

    <button type="submit" class="btn btn-primary">Guardar Factura</button>
    <a th:href="@{/invoices}" class="btn btn-secondary">Cancelar</a>
  </form>

  <!-- Script para añadir ítems dinámicamente (ejemplo básico) -->
  <script>
    function addInvoiceItem() {
        const container = document.getElementById('invoiceItemsContainer');
        const index = container.children.length;
        const itemHtml = `
            <div class="row mb-3 border p-3">
                <div class="col-md-4">
                    <label class="form-label">Descripción:</label>
                    <input type="text" name="items[${index}].description" class="form-control" required value="">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Cantidad:</label>
                    <input type="number" name="items[${index}].quantity" class="form-control" step="0.01" required value="0">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Precio Unitario:</label>
                    <input type="number" name="items[${index}].unitPrice" class="form-control" step="0.01" required value="0">
                </div>
                 <div class="col-md-2">
                    <label class="form-label">Impuesto (%):</label>
                    <input type="number" name="items[${index}].taxRate" class="form-control" step="0.01" value="0">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.row').remove()">Eliminar</button>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', itemHtml);
    }

    // Añadir un ítem por defecto al cargar la página
    document.addEventListener('DOMContentLoaded', addInvoiceItem);

  </script>
</div>
</div>
</body>
</html>